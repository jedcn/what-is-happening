#!/usr/bin/env node

const fs = require('fs');

const argv = require('minimist')(process.argv.slice(2));
const user = argv.user;

const initOctokit = require('../lib/client/initOctokit');
const analyzeUserEvents = require('../lib/userEvents/analyzeUserEvents');

const host = argv.host || 'api.github.com';

let octokit;
const usingGithubEnterprise = host !== 'api.github.com';
if (usingGithubEnterprise) {
  const pathPrefix = argv['path-prefix'] || 'api/v3';
  const accessToken = process.env.ACCESS_TOKEN;
  octokit = initOctokit({ host, pathPrefix, accessToken });
} else {
  octokit = initOctokit({ host });
}

analyzeUserEvents({ octokit, host, user })
  .then((analysis) => {
    const outputFile = `${user}.html`;
    fs.writeFile(outputFile, analysis, (err) => {
      if (err) throw err;
      console.log(`Results written to ${outputFile}`);
    });
  }).catch(err => {
    console.log('ğŸ˜¢ what-is-happening had a problem: ', err);
  });
