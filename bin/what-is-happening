#!/usr/bin/env node

const argv = require('minimist')(process.argv.slice(2));
const user = argv.user;

const initOctokit = require('../lib/github/client/initOctokit');
const fetchUserEvents = require('../lib/github/core/fetchUserEvents');
const processUserEventsData = require('../lib/github/core/processUserEventsData');
const renderContentFromEvents = require('../lib/github/render/renderContentFromEvents');
const writeContentToFile = require('../lib/github/render/writeContentToFile');

const host = argv.host || 'api.github.com';

let octokit;
const usingGithubEnterprise = host !== 'api.github.com';
if (usingGithubEnterprise) {
  const pathPrefix = argv['path-prefix'] || 'api/v3';
  const accessToken = process.env.ACCESS_TOKEN;
  octokit = initOctokit({ host, pathPrefix, accessToken });
} else {
  octokit = initOctokit({ host });
}

const { subDays } = require('date-fns');
const beginning = subDays(new Date(), 7);

fetchUserEvents({ octokit, user, beginning })
  .then((userEventsData) => {
    const processedEvents = processUserEventsData({ host, userEventsData });
    const renderedContent = renderContentFromEvents({
      begin: beginning,
      end: new Date(),
      processedEvents,
      user
    });
    const outputFile = `${user}.html`;
    writeContentToFile(renderedContent, outputFile);
    console.log(`Results written to ${outputFile}`);
  }).catch(err => {
    console.log('ğŸ˜¢ what-is-happening had a problem: ', err);
  });
